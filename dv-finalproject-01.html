
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>NYC Storms &amp; 311 Flooding Service Requests Part 1: Data Preparation &#8212; postgis-book</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="NYC Storms &amp; 311 Flooding Service Requests Part 2: Storm Identification &amp; Spatial Queries" href="dv-finalproject-2.html" />
    <link rel="prev" title="Geometry Operations and Spatial Analysis" href="dv-lab-08.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">postgis-book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-01.html">
   Basic SQL SELECT queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-02.html">
   Update, Alter, Join, Views
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-03.html">
   Spatial Data Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-04.html">
   Basic Spatial Data Manipulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-05.html">
   Spatial Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-06.html">
   Spatial Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-07.html">
   Update and Proximity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-lab-08.html">
   Geometry Operations and Spatial Analysis
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   NYC Storms &amp; 311 Flooding Service Requests Part 1: Data Preparation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-finalproject-2.html">
   NYC Storms &amp; 311 Flooding Service Requests Part 2: Storm Identification &amp; Spatial Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dv-finalproject-3.html">
   NYC Storms &amp; 311 Flooding Service Requests Part 3: Report
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/dvignoles/postgis-book/main?urlpath=tree/docs/dv-finalproject-01.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/dvignoles/postgis-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/dvignoles/postgis-book/issues/new?title=Issue%20on%20page%20%2Fdv-finalproject-01.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/dv-finalproject-01.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#site-metadata">
   Site Metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daily-streamflow">
   Daily Streamflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daily-tidal-highs">
   Daily Tidal Highs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#precipitation-daily-summaries">
   Precipitation Daily Summaries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#service-requests-containing-flooding">
   311 Service Requests containing “flooding”
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nyc-neighborhood-tabulation-areas-ntas">
   NYC Neighborhood Tabulation Areas (NTAs)
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>NYC Storms & 311 Flooding Service Requests Part 1: Data Preparation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#site-metadata">
   Site Metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daily-streamflow">
   Daily Streamflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#daily-tidal-highs">
   Daily Tidal Highs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#precipitation-daily-summaries">
   Precipitation Daily Summaries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#service-requests-containing-flooding">
   311 Service Requests containing “flooding”
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nyc-neighborhood-tabulation-areas-ntas">
   NYC Neighborhood Tabulation Areas (NTAs)
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="nyc-storms-311-flooding-service-requests-part-1-data-preparation">
<h1>NYC Storms &amp; 311 Flooding Service Requests Part 1: Data Preparation<a class="headerlink" href="#nyc-storms-311-flooding-service-requests-part-1-data-preparation" title="Permalink to this headline">#</a></h1>
<p><strong><a class="reference external" href="https://dvignoles.github.io/postgis-book/dv-finalproject-01.html">part 1</a></strong></p>
<p><a class="reference external" href="https://dvignoles.github.io/postgis-book/dv-finalproject-2.html">part 2</a></p>
<p><a class="reference external" href="https://dvignoles.github.io/postgis-book/dv-finalproject-3.html">part 3</a></p>
<p>The goal of this project is to:</p>
<p>(A) Use the local environmental record to identify storms in NYC from 2010-present</p>
<p>(B) Use flooding service requests made to 311 to identify storms in NYC from 2010-present</p>
<p>(C) Use the spatial distribution of flooding service requests made to 311 for each identified storm as proxy for flooding susceptibility due to storms.</p>
<p>This section covers loading our data sources into PostGIS and creating needed summary tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
</pre></div>
</div>
</div>
</div>
<p>If database not created run “<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">create-storms-db</span></code>”. See <code class="docutils literal notranslate"><span class="pre">makefile</span></code> in project repo for details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">engine_str</span> <span class="o">=</span> <span class="s2">&quot;postgresql+psycopg2://docker:docker@0.0.0.0:25432/storms&quot;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">engine_str</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
<span class="o">%</span><span class="k">sql</span> $engine.url
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Connected: docker@storms&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> CREATE EXTENSION IF NOT EXISTS postgis;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<section id="site-metadata">
<h2>Site Metadata<a class="headerlink" href="#site-metadata" title="Permalink to this headline">#</a></h2>
<p>Several of the data products are time series “panel” data at georeferenced sites. To maintain database normality, let’s store the site information in a separate table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 
CREATE TABLE IF NOT EXISTS sites (
    id serial UNIQUE,
    source varchar(20),
    source_site_id varchar(20),
    site_name varchar(50),
    geom geometry(POINT)
);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
<section id="daily-streamflow">
<h2>Daily Streamflow<a class="headerlink" href="#daily-streamflow" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> tables &lt;&lt;
SELECT * FROM pg_catalog.pg_tables WHERE schemaname=&#39;public&#39; AND tableowner=&#39;docker&#39;;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
22 rows affected.
Returning data to local variable tables
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
INSERT INTO sites (source, source_site_id, site_name, geom)
VALUES (&#39;USGS&#39;, &#39;01302020&#39;, &#39;BRONX RIVER AT NY BOTANICAL GARDEN AT BRONX NY&#39;, ST_Transform(ST_Point(-73.87438889, 40.86230556, 4269), 4263))
ON CONFLICT DO NOTHING
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usgs_csv</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../data/usgs_bronx.csv&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">usgs_csv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://nwis.waterdata.usgs.gov/usa/nwis/uv/?cb_00060=on&amp;cb_00065=on&amp;format=rdb&amp;site_no=01302020&amp;legacy=1&amp;period=&amp;begin_date=2010-01-01&amp;end_date=2022-12-11&#39;</span><span class="p">)</span>
    <span class="n">usgs_raw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">usgs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">usgs_raw</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="mi">31</span><span class="p">,])</span>
    <span class="n">usgs_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/usgs_bronx.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">usgs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">usgs_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usgs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">usgs_df</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
<span class="n">usgs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">usgs_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;106409_00065&#39;</span><span class="p">:</span> <span class="s1">&#39;gage_height_ft&#39;</span><span class="p">,</span> <span class="s1">&#39;106410_00060&#39;</span><span class="p">:</span> <span class="s1">&#39;discharge_cfs&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">usgs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">usgs_df</span> <span class="o">=</span> <span class="n">usgs_df</span><span class="p">[[</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;gage_height_ft&#39;</span><span class="p">,</span> <span class="s1">&#39;discharge_cfs&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2086563/300101538.py:1: FutureWarning: In a future version, `df.iloc[:, i] = newvals` will attempt to set the values inplace instead of always setting a new array. To retain the old behavior, use either `df[df.columns[i]] = newvals` or, if columns are non-unique, `df.isetitem(i, newvals)`
  usgs_df.loc[:, &#39;datetime&#39;] = pd.to_datetime(usgs_df.datetime, format=&#39;%Y-%m-%d %H:%M&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usgs_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>gage_height_ft</th>
      <th>discharge_cfs</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-01-01 00:00:00</th>
      <td>1</td>
      <td>0.97</td>
      <td>94.9</td>
    </tr>
    <tr>
      <th>2010-01-01 00:15:00</th>
      <td>1</td>
      <td>0.97</td>
      <td>94.9</td>
    </tr>
    <tr>
      <th>2010-01-01 00:30:00</th>
      <td>1</td>
      <td>0.97</td>
      <td>94.9</td>
    </tr>
    <tr>
      <th>2010-01-01 00:45:00</th>
      <td>1</td>
      <td>0.97</td>
      <td>94.9</td>
    </tr>
    <tr>
      <th>2010-01-01 01:00:00</th>
      <td>1</td>
      <td>0.97</td>
      <td>94.9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> tables &lt;&lt;
SELECT * FROM pg_catalog.pg_tables WHERE schemaname=&#39;public&#39; AND tableowner=&#39;docker&#39;;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
22 rows affected.
Returning data to local variable tables
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;usgs_bronx_gage&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="n">usgs_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;usgs_bronx_gage&#39;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We are only interested in values at the daily granularity. The USGS values are reported with a 15 minute temporal resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 
-- create daily table
CREATE TABLE IF NOT EXISTS usgs_bronx_gage_daily AS 

    SELECT 
        DATE_TRUNC(&#39;day&#39;, datetime)::date as date, 
        site_id, 
        MAX(gage_height_ft) as gage_height_ft_max, 
        AVG(discharge_cfs) as discharge_cfs
    FROM usgs_bronx_gage
    GROUP BY DATE_TRUNC(&#39;day&#39;, datetime), site_id
    ORDER BY date;

-- foreign key
ALTER TABLE usgs_bronx_gage_daily DROP CONSTRAINT IF EXISTS fk_site_gage;
ALTER TABLE usgs_bronx_gage_daily
    ADD CONSTRAINT fk_site_gage FOREIGN KEY (site_id)
        REFERENCES sites(id);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM usgs_bronx_gage_daily LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>date</th>
            <th>site_id</th>
            <th>gage_height_ft_max</th>
            <th>discharge_cfs</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2010-01-01</td>
            <td>1</td>
            <td>0.97</td>
            <td>89.38125000000002</td>
        </tr>
        <tr>
            <td>2010-01-02</td>
            <td>1</td>
            <td>0.94</td>
            <td>77.6625</td>
        </tr>
        <tr>
            <td>2010-01-03</td>
            <td>1</td>
            <td>0.88</td>
            <td>67.86458333333321</td>
        </tr>
        <tr>
            <td>2010-01-04</td>
            <td>1</td>
            <td>0.85</td>
            <td>60.871875000000074</td>
        </tr>
        <tr>
            <td>2010-01-05</td>
            <td>1</td>
            <td>0.83</td>
            <td>58.69687499999987</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>We will be comparing daily values to historical monthly long term means to detect possible storm events. We will also calculate the 25th quartile, 75th quartiles, and the statistical maximums for each month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS usgs_bronx_gage_mlt AS
SELECT 
    EXTRACT(&#39;MONTH&#39; FROM date) as month, 
    site_id, 
    AVG(gage_height_ft_max) as gage_height_ft_max_avg, 
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY gage_height_ft_max) AS gage_height_ft_max_iqr25,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY gage_height_ft_max) AS gage_height_ft_max_iqr75, 
    AVG(discharge_cfs) as discharge_cfs_avg,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY discharge_cfs) AS discharge_cfs_iqr25,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY discharge_cfs) AS discharge_cfs_iqr75
FROM usgs_bronx_gage_daily
GROUP BY EXTRACT(&#39;MONTH&#39; FROM date) , site_id
ORDER BY month;

ALTER TABLE usgs_bronx_gage_mlt
    ADD COLUMN IF NOT EXISTS gage_height_ft_max_iqr numeric,
    ADD COLUMN IF NOT EXISTS gage_height_ft_max_iqrmax numeric,
    ADD COLUMN IF NOT EXISTS discharge_cfs_iqr numeric,
    ADD COLUMN IF NOT EXISTS discharge_cfs_iqrmax numeric;

UPDATE usgs_bronx_gage_mlt
    SET gage_height_ft_max_iqr = gage_height_ft_max_iqr75 - gage_height_ft_max_iqr25,
    discharge_cfs_iqr = discharge_cfs_iqr75 - discharge_cfs_iqr25;

-- 75th quartile + 1.5 x Interquartile Range
UPDATE usgs_bronx_gage_mlt
    SET gage_height_ft_max_iqrmax = gage_height_ft_max_iqr75 + (1.5 * gage_height_ft_max_iqr),
    discharge_cfs_iqrmax = discharge_cfs_iqr75 + (1.5 * discharge_cfs_iqr);

-- foreign key
ALTER TABLE usgs_bronx_gage_mlt DROP CONSTRAINT IF EXISTS fk_site_gage_mlt;
ALTER TABLE usgs_bronx_gage_mlt
    ADD CONSTRAINT fk_site_gage_mlt FOREIGN KEY (site_id)
        REFERENCES sites(id);
SELECT * FROM usgs_bronx_gage_mlt;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
Done.
12 rows affected.
12 rows affected.
Done.
Done.
12 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>month</th>
            <th>site_id</th>
            <th>gage_height_ft_max_avg</th>
            <th>gage_height_ft_max_iqr25</th>
            <th>gage_height_ft_max_iqr75</th>
            <th>discharge_cfs_avg</th>
            <th>discharge_cfs_iqr25</th>
            <th>discharge_cfs_iqr75</th>
            <th>gage_height_ft_max_iqr</th>
            <th>gage_height_ft_max_iqrmax</th>
            <th>discharge_cfs_iqr</th>
            <th>discharge_cfs_iqrmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>1</td>
            <td>0.9028287841191059</td>
            <td>0.7</td>
            <td>0.93</td>
            <td>73.12444870177197</td>
            <td>38.24947916666673</td>
            <td>79.12187500000006</td>
            <td>0.23</td>
            <td>1.275</td>
            <td>40.8723958333333</td>
            <td>140.43046875</td>
        </tr>
        <tr>
            <td>2</td>
            <td>1</td>
            <td>0.9465667574931881</td>
            <td>0.73</td>
            <td>1.01</td>
            <td>81.98060629742612</td>
            <td>43.802083333333314</td>
            <td>89.00624999999995</td>
            <td>0.28</td>
            <td>1.43</td>
            <td>45.2041666666666</td>
            <td>156.8125</td>
        </tr>
        <tr>
            <td>3</td>
            <td>1</td>
            <td>1.0612158808933003</td>
            <td>0.79</td>
            <td>1.13</td>
            <td>116.3898950803755</td>
            <td>56.221875000000026</td>
            <td>116.05208333333334</td>
            <td>0.34</td>
            <td>1.64</td>
            <td>59.8302083333333</td>
            <td>205.797395833333</td>
        </tr>
        <tr>
            <td>4</td>
            <td>1</td>
            <td>1.0611794871794873</td>
            <td>0.77</td>
            <td>1.15</td>
            <td>105.55898100573297</td>
            <td>51.30442708333338</td>
            <td>105.87447916666665</td>
            <td>0.38</td>
            <td>1.72</td>
            <td>54.5700520833333</td>
            <td>187.729557291667</td>
        </tr>
        <tr>
            <td>5</td>
            <td>1</td>
            <td>1.024689826302731</td>
            <td>0.73</td>
            <td>1.12</td>
            <td>86.57926350512383</td>
            <td>39.74687500000002</td>
            <td>92.8229166666666</td>
            <td>0.39</td>
            <td>1.705</td>
            <td>53.0760416666666</td>
            <td>172.436979166667</td>
        </tr>
        <tr>
            <td>6</td>
            <td>1</td>
            <td>0.9140000000000004</td>
            <td>0.66</td>
            <td>0.9875</td>
            <td>65.52605934270572</td>
            <td>30.99947916666668</td>
            <td>65.25963541666677</td>
            <td>0.3275</td>
            <td>1.47875</td>
            <td>34.2601562500001</td>
            <td>116.649869791667</td>
        </tr>
        <tr>
            <td>7</td>
            <td>1</td>
            <td>0.8712219451371576</td>
            <td>0.58</td>
            <td>0.98</td>
            <td>56.013134914141624</td>
            <td>23.018750000000047</td>
            <td>55.81875000000002</td>
            <td>0.4</td>
            <td>1.58</td>
            <td>32.8</td>
            <td>105.01875</td>
        </tr>
        <tr>
            <td>8</td>
            <td>1</td>
            <td>0.8190570719602984</td>
            <td>0.53</td>
            <td>0.85</td>
            <td>56.31492750176646</td>
            <td>18.4703125</td>
            <td>46.270312499999974</td>
            <td>0.32</td>
            <td>1.33</td>
            <td>27.8</td>
            <td>87.9703125</td>
        </tr>
        <tr>
            <td>9</td>
            <td>1</td>
            <td>0.8403589743589742</td>
            <td>0.53</td>
            <td>0.8474999999999999</td>
            <td>65.21470956651214</td>
            <td>17.015625</td>
            <td>51.326562499999966</td>
            <td>0.3175</td>
            <td>1.32375</td>
            <td>34.3109375</td>
            <td>102.79296875</td>
        </tr>
        <tr>
            <td>10</td>
            <td>1</td>
            <td>0.8362779156327539</td>
            <td>0.57</td>
            <td>0.885</td>
            <td>57.25864653667988</td>
            <td>19.55052083333335</td>
            <td>57.56927083333332</td>
            <td>0.315</td>
            <td>1.3575</td>
            <td>38.01875</td>
            <td>114.597395833333</td>
        </tr>
        <tr>
            <td>11</td>
            <td>1</td>
            <td>0.8609487179487186</td>
            <td>0.61</td>
            <td>0.88</td>
            <td>61.269140322762134</td>
            <td>28.62656250000005</td>
            <td>67.10286458333321</td>
            <td>0.27</td>
            <td>1.285</td>
            <td>38.4763020833332</td>
            <td>124.817317708333</td>
        </tr>
        <tr>
            <td>12</td>
            <td>1</td>
            <td>0.951305483028721</td>
            <td>0.655</td>
            <td>1.03</td>
            <td>80.33195802150934</td>
            <td>31.07135416666672</td>
            <td>88.98020833333332</td>
            <td>0.375</td>
            <td>1.5925</td>
            <td>57.9088541666666</td>
            <td>175.843489583333</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Finally, let’s create a table of dates where the discharge or gage height exceeds its statistical maximum value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
DROP TABLE IF EXISTS usgs_bronx_gage_daily_high_events;
CREATE TABLE usgs_bronx_gage_daily_high_events AS
WITH highs AS (
    SELECT 
    dts.site_id,
    dts.date,
    discharge_cfs,
    gage_height_ft_max,
    CASE
        WHEN discharge_cfs &gt; discharge_cfs_iqr75 THEN 1
        ELSE 0
    END discharge_cfs_gt75,
    discharge_cfs - discharge_cfs_iqr75 as discharge_cfs_diff75,
    CASE
        WHEN discharge_cfs &gt; discharge_cfs_iqrmax THEN 1
        ELSE 0
    END discharge_cfs_gtmax,
    discharge_cfs - discharge_cfs_iqrmax as discharge_cfs_diffmax,
    CASE
        WHEN gage_height_ft_max &gt;= gage_height_ft_max_iqr75 THEN 1
        ELSE 0
    END gage_height_ft_max_gt75,
    gage_height_ft_max - gage_height_ft_max_iqr75 as gage_height_ft_max_diff75,
    CASE
        WHEN gage_height_ft_max &gt;= gage_height_ft_max_iqrmax THEN 1
        ELSE 0
    END gage_height_ft_max_gtmax,
    gage_height_ft_max - gage_height_ft_max_iqrmax as gage_height_ft_max_diffmax
    FROM
    usgs_bronx_gage_daily dts
    INNER JOIN usgs_bronx_gage_mlt mlt ON EXTRACT(&#39;MONTH&#39; FROM dts.date) = mlt.month
    ORDER BY dts.date
)
SELECT 
    highs.*
FROM highs
WHERE 
    highs.discharge_cfs_gtmax = 1
        OR
    highs.gage_height_ft_max_gtmax = 1;

SELECT * FROM usgs_bronx_gage_daily_high_events
ORDER BY discharge_cfs_diff75 DESC
LIMIT 10;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
562 rows affected.
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>site_id</th>
            <th>date</th>
            <th>discharge_cfs</th>
            <th>gage_height_ft_max</th>
            <th>discharge_cfs_gt75</th>
            <th>discharge_cfs_diff75</th>
            <th>discharge_cfs_gtmax</th>
            <th>discharge_cfs_diffmax</th>
            <th>gage_height_ft_max_gt75</th>
            <th>gage_height_ft_max_diff75</th>
            <th>gage_height_ft_max_gtmax</th>
            <th>gage_height_ft_max_diffmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>2011-08-28</td>
            <td>2202.0208333333335</td>
            <td>5.18</td>
            <td>1</td>
            <td>2155.7505208333337</td>
            <td>1</td>
            <td>2114.0505208333334</td>
            <td>1</td>
            <td>4.33</td>
            <td>1</td>
            <td>3.8499999999999996</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2021-09-02</td>
            <td>2134.28125</td>
            <td>5.59</td>
            <td>1</td>
            <td>2082.9546875</td>
            <td>1</td>
            <td>2031.48828125</td>
            <td>1</td>
            <td>4.7425</td>
            <td>1</td>
            <td>4.266249999999999</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2011-03-11</td>
            <td>1680.3125</td>
            <td>4.34</td>
            <td>1</td>
            <td>1564.2604166666667</td>
            <td>1</td>
            <td>1474.515104166667</td>
            <td>1</td>
            <td>3.21</td>
            <td>1</td>
            <td>2.7</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2011-09-08</td>
            <td>1300.4270833333333</td>
            <td>3.71</td>
            <td>1</td>
            <td>1249.1005208333333</td>
            <td>1</td>
            <td>1197.6341145833333</td>
            <td>1</td>
            <td>2.8625</td>
            <td>1</td>
            <td>2.38625</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2011-04-17</td>
            <td>1341.7395833333333</td>
            <td>4.06</td>
            <td>1</td>
            <td>1235.8651041666667</td>
            <td>1</td>
            <td>1154.0100260416662</td>
            <td>1</td>
            <td>2.9099999999999997</td>
            <td>1</td>
            <td>2.34</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2011-03-07</td>
            <td>1190.9895833333333</td>
            <td>3.58</td>
            <td>1</td>
            <td>1074.9375</td>
            <td>1</td>
            <td>985.1921875000003</td>
            <td>1</td>
            <td>2.45</td>
            <td>1</td>
            <td>1.9400000000000002</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2018-04-16</td>
            <td>1179.4895833333333</td>
            <td>4.24</td>
            <td>1</td>
            <td>1073.6151041666667</td>
            <td>1</td>
            <td>991.7600260416663</td>
            <td>1</td>
            <td>3.0900000000000003</td>
            <td>1</td>
            <td>2.5200000000000005</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2010-03-30</td>
            <td>1117.28125</td>
            <td>3.61</td>
            <td>1</td>
            <td>1001.2291666666666</td>
            <td>1</td>
            <td>911.483854166667</td>
            <td>1</td>
            <td>2.48</td>
            <td>1</td>
            <td>1.97</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2014-05-01</td>
            <td>1074.4895833333333</td>
            <td>3.68</td>
            <td>1</td>
            <td>981.6666666666666</td>
            <td>1</td>
            <td>902.0526041666662</td>
            <td>1</td>
            <td>2.56</td>
            <td>1</td>
            <td>1.975</td>
        </tr>
        <tr>
            <td>1</td>
            <td>2010-03-14</td>
            <td>1022.5729166666666</td>
            <td>3.26</td>
            <td>1</td>
            <td>906.5208333333333</td>
            <td>1</td>
            <td>816.7755208333336</td>
            <td>1</td>
            <td>2.13</td>
            <td>1</td>
            <td>1.6199999999999999</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>The top two entries correspond to the dates of hurricanes Irene and Ida hitting NYC.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 
SELECT COUNT(*) 
FROM usgs_bronx_gage_daily_high_events
WHERE discharge_cfs_diffmax = 1
OR gage_height_ft_max_gtmax  = 1;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>471</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>There were 471 days with values exceeding a statistical maximum for the gage.</p>
</section>
<section id="daily-tidal-highs">
<h2>Daily Tidal Highs<a class="headerlink" href="#daily-tidal-highs" title="Permalink to this headline">#</a></h2>
<p>We are interested in the daily high water level values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
INSERT INTO sites (source, source_site_id, site_name, geom)
VALUES (&#39;NOAA&#39;, &#39;8518750&#39;, &#39;The Battery, NY&#39;, ST_Point(-74.0142, 40.7006, 4263))
ON CONFLICT DO NOTHING;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> tables &lt;&lt;
SELECT * FROM pg_catalog.pg_tables WHERE schemaname=&#39;public&#39; AND tableowner=&#39;docker&#39;;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
22 rows affected.
Returning data to local variable tables
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;tidal_battery_highs_daily&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2023</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span> <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span> <span class="k">else</span> <span class="s1">&#39;append&#39;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">0101&amp;end_date=</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">1211&amp;station=8518750&amp;product=high_low&amp;datum=STND&amp;time_zone=lst&amp;units=english&amp;format=json&#39;</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)][[</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="s1">&#39;waterlevel_stnd_ft&#39;</span><span class="p">,})</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;waterlevel_stnd_ft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">waterlevel_stnd_ft</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Float64Dtype</span><span class="p">())</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;tidal_battery_highs_daily&#39;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
ALTER TABLE tidal_battery_highs_daily DROP CONSTRAINT IF EXISTS fk_site_tides;
ALTER TABLE tidal_battery_highs_daily
    ADD CONSTRAINT fk_site_tides FOREIGN KEY (site_id)
        REFERENCES sites(id);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM tidal_battery_highs_daily LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>datetime</th>
            <th>site_id</th>
            <th>waterlevel_stnd_ft</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2010-01-01 08:12:00</td>
            <td>2</td>
            <td>9.869</td>
        </tr>
        <tr>
            <td>2010-01-01 20:42:00</td>
            <td>2</td>
            <td>8.996</td>
        </tr>
        <tr>
            <td>2010-01-02 09:18:00</td>
            <td>2</td>
            <td>9.865</td>
        </tr>
        <tr>
            <td>2010-01-02 21:36:00</td>
            <td>2</td>
            <td>7.717</td>
        </tr>
        <tr>
            <td>2010-01-03 10:06:00</td>
            <td>2</td>
            <td>7.631</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Let’s calculate the monthly IQR values using the same process as with the Bronx streamflow gage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS tidal_battery_highs_mlt AS
SELECT 
    EXTRACT(&#39;MONTH&#39; FROM datetime) as month, 
    site_id, 
    AVG(waterlevel_stnd_ft) as waterlevel_stnd_ft_avg, 
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY waterlevel_stnd_ft) AS waterlevel_stnd_ft_iqr25,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY waterlevel_stnd_ft) AS waterlevel_stnd_ft_iqr75
FROM tidal_battery_highs_daily
GROUP BY EXTRACT(&#39;MONTH&#39; FROM datetime) , site_id
ORDER BY month;

ALTER TABLE tidal_battery_highs_mlt
    ADD COLUMN IF NOT EXISTS waterlevel_stnd_ft_iqr numeric,
    ADD COLUMN IF NOT EXISTS waterlevel_stnd_ft_iqrmax numeric;

UPDATE tidal_battery_highs_mlt
    SET waterlevel_stnd_ft_iqr = waterlevel_stnd_ft_iqr75 - waterlevel_stnd_ft_iqr25;

-- 75th quartile + 1.5 x Interquartile Range
UPDATE tidal_battery_highs_mlt
    SET waterlevel_stnd_ft_iqrmax = waterlevel_stnd_ft_iqr75 + (1.5 * waterlevel_stnd_ft_iqr);

-- foreign key
ALTER TABLE tidal_battery_highs_mlt DROP CONSTRAINT IF EXISTS fk_site_tidal_mlt;
ALTER TABLE tidal_battery_highs_mlt
    ADD CONSTRAINT fk_site_tidal_mlt FOREIGN KEY (site_id)
        REFERENCES sites(id);

SELECT * FROM tidal_battery_highs_mlt;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
Done.
12 rows affected.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12 rows affected.
Done.
Done.
12 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>month</th>
            <th>site_id</th>
            <th>waterlevel_stnd_ft_avg</th>
            <th>waterlevel_stnd_ft_iqr25</th>
            <th>waterlevel_stnd_ft_iqr75</th>
            <th>waterlevel_stnd_ft_iqr</th>
            <th>waterlevel_stnd_ft_iqrmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>2</td>
            <td>8.094671373555846</td>
            <td>7.464</td>
            <td>8.7185</td>
            <td>1.2545</td>
            <td>10.60025</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2</td>
            <td>8.03254442877292</td>
            <td>7.402</td>
            <td>8.691</td>
            <td>1.289</td>
            <td>10.6245</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2</td>
            <td>8.266475703324808</td>
            <td>7.657</td>
            <td>8.91</td>
            <td>1.253</td>
            <td>10.7895</td>
        </tr>
        <tr>
            <td>4</td>
            <td>2</td>
            <td>8.424626826029217</td>
            <td>7.894</td>
            <td>8.894</td>
            <td>1</td>
            <td>10.394</td>
        </tr>
        <tr>
            <td>5</td>
            <td>2</td>
            <td>8.486006426735218</td>
            <td>8.012</td>
            <td>8.901</td>
            <td>0.888999999999999</td>
            <td>10.2345</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2</td>
            <td>8.605956233421747</td>
            <td>8.186</td>
            <td>8.98</td>
            <td>0.794</td>
            <td>10.171</td>
        </tr>
        <tr>
            <td>7</td>
            <td>2</td>
            <td>8.599311538461539</td>
            <td>8.16825</td>
            <td>9.0045</td>
            <td>0.83625</td>
            <td>10.258875</td>
        </tr>
        <tr>
            <td>8</td>
            <td>2</td>
            <td>8.666285347043699</td>
            <td>8.241999999999999</td>
            <td>9.098</td>
            <td>0.856000000000002</td>
            <td>10.382</td>
        </tr>
        <tr>
            <td>9</td>
            <td>2</td>
            <td>8.749167330677286</td>
            <td>8.268</td>
            <td>9.186</td>
            <td>0.917999999999999</td>
            <td>10.563</td>
        </tr>
        <tr>
            <td>10</td>
            <td>2</td>
            <td>8.740281853281854</td>
            <td>8.205</td>
            <td>9.265</td>
            <td>1.06</td>
            <td>10.855</td>
        </tr>
        <tr>
            <td>11</td>
            <td>2</td>
            <td>8.371181034482765</td>
            <td>7.85025</td>
            <td>8.88875</td>
            <td>1.0385</td>
            <td>10.4465</td>
        </tr>
        <tr>
            <td>12</td>
            <td>2</td>
            <td>8.34051968503937</td>
            <td>7.71025</td>
            <td>8.89925</td>
            <td>1.189</td>
            <td>10.68275</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>To do the tide cycle, there are usually two peak water level values for a given day. We will create a view with the maximum peak for each date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE OR REPLACE VIEW tidal_battery_highs_daily_max AS
    SELECT 
    dts.site_id,
    dts.datetime::date as date,
    MAX(waterlevel_stnd_ft) AS waterlevel_stnd_ft
    FROM tidal_battery_highs_daily dts
    GROUP BY dts.datetime::date, site_id
    ORDER BY date;

SELECT * FROM tidal_battery_highs_daily_max LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>site_id</th>
            <th>date</th>
            <th>waterlevel_stnd_ft</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2</td>
            <td>2010-01-01</td>
            <td>9.869</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2010-01-02</td>
            <td>9.865</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2010-01-03</td>
            <td>7.631</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2010-01-04</td>
            <td>8.944</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2010-01-05</td>
            <td>8.53</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS tidal_battery_highs_events AS
WITH highs AS (
    SELECT 
    daily.site_id,
    daily.date,
    daily.waterlevel_stnd_ft,
    CASE
        WHEN waterlevel_stnd_ft &gt; waterlevel_stnd_ft_iqr75 THEN 1
        ELSE 0
    END waterlevel_stnd_ft_gt75,
    waterlevel_stnd_ft - waterlevel_stnd_ft_iqr75 as waterlevel_stnd_ft_diff75,
    CASE
        WHEN waterlevel_stnd_ft &gt; waterlevel_stnd_ft_iqrmax THEN 1
        ELSE 0
    END waterlevel_stnd_ft_gtmax,
    waterlevel_stnd_ft - waterlevel_stnd_ft_iqrmax as waterlevel_stnd_ft_diffmax
    FROM tidal_battery_highs_daily_max daily
    INNER JOIN tidal_battery_highs_mlt mlt ON EXTRACT(&#39;MONTH&#39; FROM daily.date) = mlt.month
    ORDER BY daily.date
)
SELECT 
    highs.*
FROM highs
WHERE 
    highs.waterlevel_stnd_ft_gtmax = 1;


SELECT * FROM tidal_battery_highs_events
ORDER BY waterlevel_stnd_ft_diff75 DESC
LIMIT 10;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>site_id</th>
            <th>date</th>
            <th>waterlevel_stnd_ft</th>
            <th>waterlevel_stnd_ft_gt75</th>
            <th>waterlevel_stnd_ft_diff75</th>
            <th>waterlevel_stnd_ft_gtmax</th>
            <th>waterlevel_stnd_ft_diffmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2</td>
            <td>2012-10-29</td>
            <td>17.329</td>
            <td>1</td>
            <td>8.064</td>
            <td>1</td>
            <td>6.474</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2011-08-28</td>
            <td>12.795</td>
            <td>1</td>
            <td>3.696999999999999</td>
            <td>1</td>
            <td>2.4130000000000003</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2010-03-13</td>
            <td>12.09</td>
            <td>1</td>
            <td>3.1799999999999997</td>
            <td>1</td>
            <td>1.3004999999999995</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2016-02-09</td>
            <td>11.24</td>
            <td>1</td>
            <td>2.5489999999999995</td>
            <td>1</td>
            <td>0.6155000000000008</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2011-04-16</td>
            <td>11.385</td>
            <td>1</td>
            <td>2.4909999999999997</td>
            <td>1</td>
            <td>0.9909999999999997</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2016-01-10</td>
            <td>11.165</td>
            <td>1</td>
            <td>2.4464999999999986</td>
            <td>1</td>
            <td>0.5647499999999983</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2016-02-08</td>
            <td>11.102</td>
            <td>1</td>
            <td>2.4109999999999996</td>
            <td>1</td>
            <td>0.4775000000000009</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2018-10-27</td>
            <td>11.66</td>
            <td>1</td>
            <td>2.3949999999999996</td>
            <td>1</td>
            <td>0.8049999999999997</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2021-02-01</td>
            <td>11.076</td>
            <td>1</td>
            <td>2.385</td>
            <td>1</td>
            <td>0.4515000000000011</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2018-03-03</td>
            <td>11.188</td>
            <td>1</td>
            <td>2.2780000000000005</td>
            <td>1</td>
            <td>0.3985000000000003</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Our highest highs correspond to major storm events in NYC as expected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
SELECT COUNT(*) 
FROM tidal_battery_highs_events
WHERE waterlevel_stnd_ft_gtmax = 1;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>56</td>
        </tr>
    </tbody>
</table></div></div>
</div>
</section>
<section id="precipitation-daily-summaries">
<h2>Precipitation Daily Summaries<a class="headerlink" href="#precipitation-daily-summaries" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precip_csv</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../data/precipitation_nyc.csv&#39;</span><span class="p">)</span>
<span class="n">precip_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">precip_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stations</span> <span class="o">=</span> <span class="n">precip_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;STATION&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;STATION&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LATITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;LONGITUDE&#39;</span><span class="p">]]</span>
<span class="n">site_id</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INSERT INTO sites (id, source, source_site_id, site_name, geom) &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;VALUES (</span><span class="si">{</span><span class="n">site_id</span><span class="si">}</span><span class="s2">, &#39;NCEI&#39;, &#39;</span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">STATION</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">NAME</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ST_Point(</span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">LONGITUDE</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">station</span><span class="o">.</span><span class="n">LATITUDE</span><span class="si">}</span><span class="s2">, 4263)) ON CONFLICT DO NOTHING;&quot;</span><span class="p">)</span>
        
        <span class="n">precip_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">precip_df</span><span class="o">.</span><span class="n">STATION</span> <span class="o">==</span> <span class="n">station</span><span class="o">.</span><span class="n">STATION</span><span class="p">,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">site_id</span><span class="p">)</span>
        <span class="n">site_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precip_df</span> <span class="o">=</span> <span class="n">precip_df</span><span class="p">[[</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;DATE&#39;</span><span class="p">,</span> <span class="s1">&#39;PRCP&#39;</span><span class="p">]]</span>
<span class="n">precip_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;site_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precip_df</span><span class="o">.</span><span class="n">site_id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">precip_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;DATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">precip_df</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">precip_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PRCP&#39;</span><span class="p">:</span> <span class="s1">&#39;prcp&#39;</span><span class="p">,</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">precip_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">precip_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2086563/2531588765.py:2: FutureWarning: In a future version, `df.iloc[:, i] = newvals` will attempt to set the values inplace instead of always setting a new array. To retain the old behavior, use either `df[df.columns[i]] = newvals` or, if columns are non-unique, `df.isetitem(i, newvals)`
  precip_df.loc[:, &#39;site_id&#39;] = precip_df.site_id.astype(int)
/tmp/ipykernel_2086563/2531588765.py:3: FutureWarning: In a future version, `df.iloc[:, i] = newvals` will attempt to set the values inplace instead of always setting a new array. To retain the old behavior, use either `df[df.columns[i]] = newvals` or, if columns are non-unique, `df.isetitem(i, newvals)`
  precip_df.loc[:, &#39;DATE&#39;] = pd.to_datetime(precip_df.DATE, format=&#39;%Y-%m-%d&#39;)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>prcp</th>
    </tr>
    <tr>
      <th>site_id</th>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">6</th>
      <th>2010-01-01</th>
      <td>0.03</td>
    </tr>
    <tr>
      <th>2010-01-02</th>
      <td>0.02</td>
    </tr>
    <tr>
      <th>2010-01-03</th>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2010-01-04</th>
      <td>0.00</td>
    </tr>
    <tr>
      <th>2010-01-05</th>
      <td>0.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> tables &lt;&lt;
SELECT * FROM pg_catalog.pg_tables WHERE schemaname=&#39;public&#39; AND tableowner=&#39;docker&#39;;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
22 rows affected.
Returning data to local variable tables
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;ncei_precip_daily&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="n">precip_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;ncei_precip_daily&#39;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM ncei_precip_daily LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>site_id</th>
            <th>date</th>
            <th>prcp</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>3</td>
            <td>2022-05-30 00:00:00</td>
            <td>None</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2010-01-01 00:00:00</td>
            <td>0.03</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2010-01-02 00:00:00</td>
            <td>0.02</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2010-01-03 00:00:00</td>
            <td>0.0</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2010-01-04 00:00:00</td>
            <td>0.0</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
ALTER TABLE ncei_precip_daily DROP CONSTRAINT IF EXISTS fk_site_tides;
ALTER TABLE ncei_precip_daily
    ADD CONSTRAINT fk_site_tides FOREIGN KEY (site_id)
        REFERENCES sites(id);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>Lets create a view for each station for later convenience.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
-- staten island
CREATE OR REPLACE VIEW ncei_precip_daily_si AS
SELECT * FROM ncei_precip_daily WHERE site_id = 3;

-- laguardia airport
CREATE OR REPLACE VIEW ncei_precip_daily_lag AS
SELECT * FROM ncei_precip_daily WHERE site_id = 4;

-- newark airport
CREATE OR REPLACE VIEW ncei_precip_daily_nwk AS
SELECT * FROM ncei_precip_daily WHERE site_id = 5;

-- central park
CREATE OR REPLACE VIEW ncei_precip_daily_cp AS
SELECT * FROM ncei_precip_daily WHERE site_id = 6;

-- JFK airport 
CREATE OR REPLACE VIEW ncei_precip_daily_jfk AS
SELECT * FROM ncei_precip_daily WHERE site_id = 7;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
Done.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>In the case of precipitation, many of the daily sums are zero. The 75th quartile is quite low, so we will use the 95th and 99th percentile values as our markers for “significant precipitation”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS ncei_precip_mlt AS
SELECT 
    EXTRACT(&#39;MONTH&#39; FROM date) as month, 
    site_id, 
    AVG(prcp) as prcp_avg, 
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY prcp) AS prcp_95,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY prcp) AS prcp_99
FROM ncei_precip_daily
GROUP BY EXTRACT(&#39;MONTH&#39; FROM date) , site_id
ORDER BY month;

-- foreign key
ALTER TABLE ncei_precip_mlt DROP CONSTRAINT IF EXISTS fk_site_tidal_mlt;
ALTER TABLE ncei_precip_mlt
    ADD CONSTRAINT fk_site_tidal_mlt FOREIGN KEY (site_id)
        REFERENCES sites(id);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM ncei_precip_mlt LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>month</th>
            <th>site_id</th>
            <th>prcp_avg</th>
            <th>prcp_95</th>
            <th>prcp_99</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>3</td>
            <td>0.11689349112426037</td>
            <td>0.6774999999999989</td>
            <td>1.7777999999999998</td>
        </tr>
        <tr>
            <td>1</td>
            <td>4</td>
            <td>0.09960297766749383</td>
            <td>0.6499999999999978</td>
            <td>1.2180000000000017</td>
        </tr>
        <tr>
            <td>1</td>
            <td>5</td>
            <td>0.10267990074441688</td>
            <td>0.6289999999999998</td>
            <td>1.299000000000001</td>
        </tr>
        <tr>
            <td>1</td>
            <td>6</td>
            <td>0.11054590570719602</td>
            <td>0.7079999999999995</td>
            <td>1.3292000000000008</td>
        </tr>
        <tr>
            <td>1</td>
            <td>7</td>
            <td>0.10367245657568241</td>
            <td>0.6279999999999996</td>
            <td>1.279000000000001</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 
CREATE TABLE IF NOT EXISTS ncei_precip_daily_events AS
WITH highs as(
    SELECT dts.site_id, dts.date,
    prcp,
    CASE
        WHEN prcp &gt; prcp_99 THEN 1
        ELSE 0
    END prcp_gt99,
    prcp - prcp_99 as prcp_diff99
    FROM ncei_precip_daily dts
    JOIN ncei_precip_mlt mlt
    ON dts.site_id = mlt.site_id
    AND EXTRACT(&#39;MONTH&#39; FROM dts.date) = mlt.month
    ORDER BY dts.date
)
SELECT 
    highs.*
FROM highs
WHERE 
    highs.prcp_gt99 = 1;

-- demo
SELECT * FROM ncei_precip_daily_events
ORDER BY prcp_diff99 DESC
LIMIT 10;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>site_id</th>
            <th>date</th>
            <th>prcp</th>
            <th>prcp_gt99</th>
            <th>prcp_diff99</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>5</td>
            <td>2021-09-01 00:00:00</td>
            <td>8.41</td>
            <td>1</td>
            <td>6.9789</td>
        </tr>
        <tr>
            <td>7</td>
            <td>2011-08-14 00:00:00</td>
            <td>7.8</td>
            <td>1</td>
            <td>5.461599999999999</td>
        </tr>
        <tr>
            <td>6</td>
            <td>2021-09-01 00:00:00</td>
            <td>7.13</td>
            <td>1</td>
            <td>5.1789</td>
        </tr>
        <tr>
            <td>4</td>
            <td>2021-09-01 00:00:00</td>
            <td>6.8</td>
            <td>1</td>
            <td>5.0769999999999955</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2021-09-02 00:00:00</td>
            <td>6.78</td>
            <td>1</td>
            <td>4.911800000000001</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2011-08-28 00:00:00</td>
            <td>7.12</td>
            <td>1</td>
            <td>4.7378000000000045</td>
        </tr>
        <tr>
            <td>5</td>
            <td>2011-08-14 00:00:00</td>
            <td>6.4</td>
            <td>1</td>
            <td>4.712999999999997</td>
        </tr>
        <tr>
            <td>4</td>
            <td>2011-08-14 00:00:00</td>
            <td>6.6</td>
            <td>1</td>
            <td>4.659199999999991</td>
        </tr>
        <tr>
            <td>4</td>
            <td>2014-04-30 00:00:00</td>
            <td>5.26</td>
            <td>1</td>
            <td>3.646799999999998</td>
        </tr>
        <tr>
            <td>5</td>
            <td>2011-08-28 00:00:00</td>
            <td>5.22</td>
            <td>1</td>
            <td>3.532999999999997</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT COUNT(*) FROM ncei_precip_daily_events;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>260</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>There were 260 99th% precipitation events among the 4 stations from 2010-2022.</p>
</section>
<section id="service-requests-containing-flooding">
<h2>311 Service Requests containing “flooding”<a class="headerlink" href="#service-requests-containing-flooding" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flood_csv</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../data/flooding_311.csv&#39;</span><span class="p">)</span>
<span class="n">flood_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">flood_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2086563/4021587811.py:2: DtypeWarning: Columns (20) have mixed types. Specify dtype option on import or set low_memory=False.
  flood_df = pd.read_csv(flood_csv)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> tables &lt;&lt;
SELECT * FROM pg_catalog.pg_tables WHERE schemaname=&#39;public&#39; AND tableowner=&#39;docker&#39;;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
22 rows affected.
Returning data to local variable tables
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_rename</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">col</span>

<span class="k">if</span> <span class="s1">&#39;nyc_311_flooding&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">flood_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="n">_rename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flood_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;created_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">flood_df</span><span class="o">.</span><span class="n">created_date</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %I:%M:%S %p&#39;</span><span class="p">)</span>
    <span class="n">flood_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;closed_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">flood_df</span><span class="o">.</span><span class="n">closed_date</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %I:%M:%S %p&#39;</span><span class="p">)</span>
    <span class="n">flood_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;nyc_311_flooding&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="n">flood_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;nyc_311_flooding&#39;</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
-- remove non-georeferenced complaints
DELETE FROM nyc_311_flooding
WHERE longitude IS NULL
OR latitude is NULL;

-- add geometry
ALTER TABLE nyc_311_flooding
ADD COLUMN IF NOT EXISTS geom geometry(POINT);

UPDATE nyc_311_flooding
SET geom = ST_Point(longitude, latitude, 4326);

-- add geography
ALTER TABLE nyc_311_flooding
ADD COLUMN IF NOT EXISTS geog geography(POINT);

UPDATE nyc_311_flooding
SET geog = geom::geography;


-- long island state plane
ALTER TABLE nyc_311_flooding
ADD COLUMN IF NOT EXISTS geom_2263 geometry(POINT);

UPDATE nyc_311_flooding
SET geom_2263 = ST_Transform(geom, 2263);


-- add spatial index
CREATE INDEX IF NOT EXISTS nyc_flooding_311_geom_idx on nyc_311_flooding USING gist(geom);
CREATE INDEX IF NOT EXISTS nyc_flooding_311_geom_2263_idx on nyc_311_flooding USING gist(geom_2263);
CREATE INDEX IF NOT EXISTS nyc_flooding_311_geog_idx on nyc_311_flooding USING gist(geog);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
0 rows affected.
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136108 rows affected.
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136108 rows affected.
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136108 rows affected.
Done.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT DISTINCT descriptor FROM nyc_311_flooding;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>descriptor</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>RAIN GARDEN FLOODING (SRGFLD)</td>
        </tr>
        <tr>
            <td>Street Flooding (SJ)</td>
        </tr>
        <tr>
            <td>Highway Flooding (SH)</td>
        </tr>
        <tr>
            <td>Catch Basin Clogged/Flooding (Use Comments) (SC)</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE OR REPLACE VIEW nyc_311_flooding_daily_complaints AS
    SELECT 
    created_date::date as date,
    COUNT(created_date) as num_complaints
    FROM nyc_311_flooding
    GROUP BY created_date::date
    ORDER BY num_complaints DESC;
SELECT * FROM nyc_311_flooding_daily_complaints LIMIT 10;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>date</th>
            <th>num_complaints</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2021-09-02</td>
            <td>645</td>
        </tr>
        <tr>
            <td>2011-08-25</td>
            <td>623</td>
        </tr>
        <tr>
            <td>2014-12-09</td>
            <td>537</td>
        </tr>
        <tr>
            <td>2021-09-01</td>
            <td>530</td>
        </tr>
        <tr>
            <td>2017-05-05</td>
            <td>492</td>
        </tr>
        <tr>
            <td>2021-10-26</td>
            <td>472</td>
        </tr>
        <tr>
            <td>2014-04-30</td>
            <td>446</td>
        </tr>
        <tr>
            <td>2013-05-08</td>
            <td>406</td>
        </tr>
        <tr>
            <td>2010-03-30</td>
            <td>381</td>
        </tr>
        <tr>
            <td>2011-08-26</td>
            <td>379</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS nyc_311_flooding_mlt AS
SELECT 
    EXTRACT(&#39;MONTH&#39; FROM date) as month, 
    AVG(num_complaints)::int as num_complaints_avg, 
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY num_complaints) AS num_complaints_iqr25,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY num_complaints) AS num_complaints_iqr75
FROM nyc_311_flooding_daily_complaints
GROUP BY EXTRACT(&#39;MONTH&#39; FROM date)
ORDER BY month;

ALTER TABLE nyc_311_flooding_mlt
    ADD COLUMN IF NOT EXISTS num_complaints_iqr numeric,
    ADD COLUMN IF NOT EXISTS num_complaints_iqrmax numeric;

UPDATE nyc_311_flooding_mlt
    SET num_complaints_iqr = num_complaints_iqr75 - num_complaints_iqr25;

-- 75th quartile + 1.5 x Interquartile Range
UPDATE nyc_311_flooding_mlt
    SET num_complaints_iqrmax = num_complaints_iqr75 + (1.5 * num_complaints_iqr);

SELECT * FROM nyc_311_flooding_mlt;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done.
12 rows affected.
12 rows affected.
12 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>month</th>
            <th>num_complaints_avg</th>
            <th>num_complaints_iqr25</th>
            <th>num_complaints_iqr75</th>
            <th>num_complaints_iqr</th>
            <th>num_complaints_iqrmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>17</td>
            <td>7.0</td>
            <td>20.0</td>
            <td>13</td>
            <td>39.5</td>
        </tr>
        <tr>
            <td>2</td>
            <td>23</td>
            <td>8.0</td>
            <td>21.0</td>
            <td>13</td>
            <td>40.5</td>
        </tr>
        <tr>
            <td>3</td>
            <td>24</td>
            <td>9.0</td>
            <td>26.0</td>
            <td>17</td>
            <td>51.5</td>
        </tr>
        <tr>
            <td>4</td>
            <td>25</td>
            <td>10.0</td>
            <td>27.75</td>
            <td>17.75</td>
            <td>54.375</td>
        </tr>
        <tr>
            <td>5</td>
            <td>36</td>
            <td>13.25</td>
            <td>39.75</td>
            <td>26.5</td>
            <td>79.5</td>
        </tr>
        <tr>
            <td>6</td>
            <td>36</td>
            <td>15.0</td>
            <td>40.0</td>
            <td>25</td>
            <td>77.5</td>
        </tr>
        <tr>
            <td>7</td>
            <td>36</td>
            <td>16.0</td>
            <td>42.0</td>
            <td>26</td>
            <td>81</td>
        </tr>
        <tr>
            <td>8</td>
            <td>39</td>
            <td>17.0</td>
            <td>42.5</td>
            <td>25.5</td>
            <td>80.75</td>
        </tr>
        <tr>
            <td>9</td>
            <td>36</td>
            <td>13.0</td>
            <td>38.0</td>
            <td>25</td>
            <td>75.5</td>
        </tr>
        <tr>
            <td>10</td>
            <td>28</td>
            <td>11.0</td>
            <td>30.0</td>
            <td>19</td>
            <td>58.5</td>
        </tr>
        <tr>
            <td>11</td>
            <td>23</td>
            <td>9.0</td>
            <td>23.0</td>
            <td>14</td>
            <td>44</td>
        </tr>
        <tr>
            <td>12</td>
            <td>23</td>
            <td>8.0</td>
            <td>25.0</td>
            <td>17</td>
            <td>50.5</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
CREATE TABLE IF NOT EXISTS nyc_311_flooding_events AS
WITH highs AS (
    SELECT 
    dts.date,
    num_complaints,
    CASE
        WHEN num_complaints &gt; num_complaints_iqr75 THEN 1
        ELSE 0
    END num_complaints_gt75,
    num_complaints - num_complaints_iqr75 as num_complaints_diff75,
    CASE
        WHEN num_complaints &gt; num_complaints_iqrmax THEN 1
        ELSE 0
    END num_complaints_gtmax,
    num_complaints - num_complaints_iqrmax as num_complaints_diffmax
    FROM
    nyc_311_flooding_daily_complaints dts
    INNER JOIN nyc_311_flooding_mlt mlt ON EXTRACT(&#39;MONTH&#39; FROM dts.date) = mlt.month
    ORDER BY dts.date
)
SELECT 
    highs.*
FROM highs
WHERE 
    highs.num_complaints_gtmax = 1;

SELECT * FROM nyc_311_flooding_events
ORDER BY num_complaints_diff75 DESC
LIMIT 10;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
10 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>date</th>
            <th>num_complaints</th>
            <th>num_complaints_gt75</th>
            <th>num_complaints_diff75</th>
            <th>num_complaints_gtmax</th>
            <th>num_complaints_diffmax</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>2021-09-02</td>
            <td>645</td>
            <td>1</td>
            <td>607.0</td>
            <td>1</td>
            <td>569.5</td>
        </tr>
        <tr>
            <td>2011-08-25</td>
            <td>623</td>
            <td>1</td>
            <td>580.5</td>
            <td>1</td>
            <td>542.25</td>
        </tr>
        <tr>
            <td>2014-12-09</td>
            <td>537</td>
            <td>1</td>
            <td>512.0</td>
            <td>1</td>
            <td>486.5</td>
        </tr>
        <tr>
            <td>2021-09-01</td>
            <td>530</td>
            <td>1</td>
            <td>492.0</td>
            <td>1</td>
            <td>454.5</td>
        </tr>
        <tr>
            <td>2017-05-05</td>
            <td>492</td>
            <td>1</td>
            <td>452.25</td>
            <td>1</td>
            <td>412.5</td>
        </tr>
        <tr>
            <td>2021-10-26</td>
            <td>472</td>
            <td>1</td>
            <td>442.0</td>
            <td>1</td>
            <td>413.5</td>
        </tr>
        <tr>
            <td>2014-04-30</td>
            <td>446</td>
            <td>1</td>
            <td>418.25</td>
            <td>1</td>
            <td>391.625</td>
        </tr>
        <tr>
            <td>2013-05-08</td>
            <td>406</td>
            <td>1</td>
            <td>366.25</td>
            <td>1</td>
            <td>326.5</td>
        </tr>
        <tr>
            <td>2010-03-30</td>
            <td>381</td>
            <td>1</td>
            <td>355.0</td>
            <td>1</td>
            <td>329.5</td>
        </tr>
        <tr>
            <td>2011-08-26</td>
            <td>379</td>
            <td>1</td>
            <td>336.5</td>
            <td>1</td>
            <td>298.25</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> 
SELECT COUNT(*) 
FROM nyc_311_flooding_events
WHERE num_complaints_gtmax = 1;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>391</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Let’s add a date column &amp; index to the full record to facilitate quick  joins between our summary table and the full record</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
ALTER TABLE nyc_311_flooding
ADD COLUMN IF NOT EXISTS &quot;date&quot; date,
ADD COLUMN IF NOT EXISTS &quot;month&quot; int;

UPDATE nyc_311_flooding
SET date = created_date::date;

UPDATE nyc_311_flooding
SET month = EXTRACT(&quot;MONTH&quot; FROM created_date)::int;

CREATE INDEX IF NOT EXISTS nyc_311_flooding_date_idx ON nyc_311_flooding(date);
CREATE INDEX IF NOT EXISTS nyc_311_flooding_month_idx ON nyc_311_flooding(month);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136108 rows affected.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136108 rows affected.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
<section id="nyc-neighborhood-tabulation-areas-ntas">
<h2>NYC Neighborhood Tabulation Areas (NTAs)<a class="headerlink" href="#nyc-neighborhood-tabulation-areas-ntas" title="Permalink to this headline">#</a></h2>
<p>We will use these as aggregation polygons for our analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shp_name</span> <span class="o">=</span> <span class="s1">&#39;geo_export_2296f1c1-ac4f-4cca-b927-e2e39cfcb876&#39;</span>
<span class="n">nta_shp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/tmp/nyc_ntas_2010/</span><span class="si">{</span><span class="n">shp_name</span><span class="si">}</span><span class="s1">.shp&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span> -s &quot;$nta_shp&quot; &quot;$shp_name&quot;
unzip -o ../data/nyc_ntas_2010.zip -d ../data/tmp/nyc_ntas_2010 &gt; /dev/null
gdalsrsinfo $1 | grep &quot;PROJ&quot;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PROJ.4 : +proj=longlat +ellps=WGS84 +no_defs
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span> -s &quot;$nta_shp&quot; &quot;$shp_name&quot;
ogr2ogr -f &quot;PostgreSQL&quot; \
 PG:&quot;host=&#39;0.0.0.0&#39; port=&#39;25432&#39; user=&#39;docker&#39; password=&#39;docker&#39; dbname=&#39;storms&#39;&quot; $1 $2 \
 -nlt PROMOTE_TO_MULTI \
 -nln &quot;nyc_nta_2010&quot; \
 -lco GEOMETRY_NAME=geom \
 -lco precision=NO \
 -overwrite 

# cleanup
rm -r ../data/tmp/nyc_ntas_2010
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM nyc_nta_2010 LIMIT 5;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
5 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>ogc_fid</th>
            <th>boro_code</th>
            <th>boro_name</th>
            <th>county_fip</th>
            <th>ntacode</th>
            <th>ntaname</th>
            <th>shape_area</th>
            <th>shape_leng</th>
            <th>geom</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>4.0</td>
            <td>Queens</td>
            <td>081</td>
            <td>QN08</td>
            <td>St. Albans</td>
            <td>77412747.7931</td>
            <td>45401.3169214</td>
            <td>010600002032BF0D0001000000010300000001000000D600000084F51C99217052C03B3479E9445A44407BFC9A961C7052C046CA83912E5A4440872F248B177052C06225E539185A444046B4ED99127052C0E1DF2F91025A44403E1C138F0D7052C005040E00EC5944404E0F9BB0087052C0E2889B61D659444084F3B89C037052C041A0B0CEBF59444035A1A98AFE6F52C0AA2D0251A9594440961E2ECBF96F52C074B3B1059459444029A6EF9EF46F52C08DD9CD7E7D594440D18D5229037052C036947AF375594440B97B7D37F46F52C0B04C3AD333594440BD97799BE96F52C04D2B7C55045944403A206D25E46F52C0181D4A5D07594440A3F3E90DDB6F52C0390776520C59444038BFD52ED66F52C08A9652010F5944409B91288AC26F52C00A7D69E819594440BB806170C16F52C0410FF5851A59444058FA3596C06F52C0FA20C8F91A5944407FD385F8B16F52C0A4D209CE22594440B102374EAF6F52C08779B056235944404519C79AAC6F52C0F021527523594440856DD5E8A96F52C005DBAF28235944407FAF1A43A76F52C09742CA72225944404871A6FD976F52C0ED6E88DF1D594440C1C08206976F52C0569772951D5944402746498D9B6F52C0DF0FFEDE02594440F8E5FB4BA06F52C0F336D902E7584440CCD2E80FA26F52C0123FD783DD584440D2056513A46F52C050B7191FD458444055C95655A66F52C016F681DACA584440821770D4A86F52C04734AABBC1584440F69210BFAA6F52C0FDB7F471BB5844401914008FAB6F52C08AE0D5C7B8584440547F211BAC6F52C0E5022446B75844406F6D41CCAF6F52C05B49791CAD5844405961E973C26F52C0CDEF46D87B5844409FC16689D36F52C035A9C44E495844401C834FE3D76F52C0B64295883C584440D70BDB91E86F52C0F3C0EFF309584440B471D517ED6F52C066517747FE574440256A1FEAF66F52C073EA6ADEE457444001891D79017052C0CED5E856CC574440BD6D6732047052C0E9769E2BC25744400C83FFE0107052C0C8426B9D9457444016D7299C147052C041058F998457444059DA4344197052C00A757F0D6E574440F47DE88E1D7052C00A9DFBFD585744404656F0FF247052C0D4634E1C3B57444098DA717A287052C0000651EC30574440538AF0F42B7052C0ECA050BC265744404670249A347052C034F7B34B0F57444061F3DF0D357052C0966DF3110E574440EBC741DA357052C0A4687AEA0B574440C110B19F387052C02B4F4A700457444091B2D00B3D7052C08CDB0376F8564440871ED86F417052C06EB09D91EC564440E4CA3076447052C0C7C24860E4564440FFF095724F7052C0D4F1465FC6564440946369C3557052C09CE9F862B1564440070030035A7052C02FE916CD9B5644409B2AE81D5C7052C0589C3DA38F564440783E11595C7052C0AB880E388E564440EDF849665E7052C0E764F26D8356444079E63D506A7052C00142F3E98756444088DC3E9F6C7052C0A309BEFF8A5644407AB7DB386E7052C08F5A42028E564440CB8568906F7052C009CD1551915644406B37899D707052C00665BBD794564440CC639F5B717052C09A9A7F7F985644408C49646D817052C0BA423E368B56444061CF9047837052C0B5639AB689564440182765CC9B7052C09EB5DE0D75564440AB60BCFEA87052C08E23E8006A56444012FEC3AAB67052C0D0DD80A75E564440BA521892CC7052C042E76A054C5644407E2A6E63DB7052C07A8F6BF35B564440FC670C0BDC7052C0594398C45C564440976E61C6DC7052C0AF7B836A5D564440396DA890DD7052C0B2F2F3E05D56444033E2BA64DE7052C0E9B9E5245E564440EA07333DDF7052C0183F9E345E564440472D8E14E07052C0290FB70F5E56444078E683C2E07052C02129B0FB4F5644409F947225E27052C0B6D2F6903E564440E7D31FD9FF7052C05F71B0285F564440B1813C072D7152C01252C432995644400EE881A73C7152C05EAC82CBAC564440C02CC1A44C7152C0A7F94787C0564440116C78AD597152C0CDAD16B0D0564440ACADA7CC647152C02B330096DE5644403D8E9280807152C02E236F0C015744400532FDA3947152C0816EB22A1A5744403B754C8C8A7152C00CDC1326235744408B766E18827152C039A070D3295744400629ACC1787152C05A99CBD931574440494CB9B96D7152C07E9A96183B574440FC4E18C56B7152C002D7F0013F5744406DB449A8717152C0ED4C0BA452574440FDFA9476787152C0E2EEE05F6A574440E836ED887D7152C018FAD4717B57444010159702817152C0474F7A587C574440A5A7AC3B8C7152C04615185774574440FE49DF17907152C02C1E67F5815744406C95505B927152C0DCCA659089574440CFC05362937152C0E2D31F048D5744406BC33FCD997152C0A39A9957965744402015F19FA47152C0C87EC69CA55744409D80F24AAF7152C0B0E9152DB5574440EFADAC13B77152C09A448DD0CD57444098671AF5B97152C04B26ACEED65744403AE97554BA7152C0BF8C741CD85744404916274AC87152C011DC1A7FCE574440ED61D959D67152C0BE3F0808C5574440D1402288E47152C0FBB406AEBB574440C121BC16E67152C0B49E0470BA5744403015D8ABE77152C0535D4572C657444012EC1DF8F37152C094400ED0F05744404E0307E1037252C08E97B33A275844407CB9C8EE117252C0083E24BC1D584440626DC408217252C090DDA4BB51584440F9FF3549137252C092864C345D584440DA1872C8057252C00B19B16D6858444036FE3253F87152C0C9C24EAB735844401E64CECCE77152C0686C895D3A584440F332CCB3D97152C0281CD9D943584440C5AA0D1BCA7152C002BF1F794E5844400BF94901C97152C099CF0D394F5844403D3CE762DE7152C04CD17D01885844402D972B68EF7152C0F0C84551B3584440E7D33193EE7152C06CD519B9B4584440A6A7B85BE27152C04697EA5CC9584440A865B123D57152C0C6C69D71D5584440BFB65E10C87152C06F3C8285DF5844405FAB9595BE7152C0C161C9DBF7584440F7A10801BB7152C0D726D7B201594440832812C7B37152C040B91484155944400CCAFB15AD7152C02776185929594440A8E3DE6AAB7152C0ADB6D84A2E59444021155719A67152C08C06BD493D594440358C0BAEA47152C0C78E8D4A41594440D75219FB9E7152C0D51E6E0A51594440F83C71D59B7152C02E46B9B759594440EF44A4D5977152C02AAE88C264594440089AC4F1927152C03F930F437259444068FF7BC8907152C03F0E47AC785944407CA53D81887152C05ABD603C93594440F0F73190827152C040637B6A99594440927D7A03807152C0A91073119C5944405E3C20E67B7152C0886FC6B59F59444010C3A3C4777152C09A7C9243A3594440835892AC747152C028E0EA01A65944403E72377D6D7152C0A14DC153AC5944406F2DBB50747152C02F53D6F5C25944400D83ACEC7A7152C05D868A68D9594440FE2377087E7152C0E7D713B6E3594440BB626294817152C010FC5877EF594440154F774A887152C03B5A841C065A44400C7509EA8E7152C0851AEC391C5A444062B096D29A7152C0A220C54D455A44407D97694DA37152C073EF143B485A444036410EA7A37152C06A7811344E5A44406FAF85ACA37152C063255C49545A44406A96785AA37152C0C69FD96A5A5A44403B2663AFA27152C05DF87587605A4440BE2BA5ABA17152C00933988D665A44402439B551A07152C0A149076C6C5A44408A55D1A59E7152C0200D3E12725A444059A01BAE9C7152C052697471775A44401343F2719A7152C0F8BE9E7C7C5A4440D48514FA977152C0777F0E29815A4440DF95A839937152C0360D42B3865A44400EEFF8448E7152C092B62FE08B5A444037D4C020897152C02A2B58A9905A444006AEE4EA847152C09C4E9B21945A44403E7312D2837152C0F6BA0709955A4440976BA45E7E7152C05E2A59FA985A4440C94430CC787152C0FC2668799C5A44405CAB4545757152C066B1415D9E5A4440DF2EE920737152C000591A839F5A4440725EEB626D7152C0936B9815A25A4440863B5303577152C08772DD40B45A44400E4030583A7152C0F53C8388CB5A444090B4E2352E7152C096D6D762D55A4440DE68B12A2B7152C032D790C2D15A4440C669B21F257152C017829E0FAD5A44402AD32606237152C0E9E6AF9A9F5A4440A8A4BBA21F7152C07D33A286895A4440BA30592B1C7152C04F2F4F0F735A44400FDAEDA21A7152C02A5C2C73685A444031926765177152C09F35D2D94C5A444072F7A3C3167152C04F70E339465A4440744FE51C137152C0505C8FF31C5A444042A081DC107152C0415F8FF7065A4440650277870F7152C044BBDEC3F3594440C9659E310C7152C02A59EF98ED594440EB22B430087152C0019FAF18E6594440D41D41FEFC7052C011406CECEB5944400BF93172EE7052C0F704877BF3594440351BAFF1DF7052C087AAB904FB5944404AF83164D17052C0C61F45A7025A4440EB84D2EBCE7052C0B9DCB2D1035A4440DF54EF8AB87052C08061B3870F5A444014848D7EB37052C007A5E8F0F859444054C305EFA47052C0A703CC83005A444013114771967052C0417D4418085A44404E8908EA877052C05565F4AC0F5A444047273156797052C05030E446175A4440F77622CE6A7052C07C9B10C71E5A4440A4CB15FD5B7052C0BF3B8284265A4440D80F80304D7052C01BB72F4C2E5A4440C0CCD7A63E7052C0166652C4355A4440C24AE821307052C0FA9C96613D5A444084F51C99217052C03B3479E9445A4440</td>
        </tr>
        <tr>
            <td>2</td>
            <td>2.0</td>
            <td>Bronx</td>
            <td>005</td>
            <td>BX28</td>
            <td>Van Cortlandt Village</td>
            <td>25666124.5948</td>
            <td>21945.719299</td>
            <td>010600002032BF0D00010000000103000000010000008A000000FA725773C57852C0BA3EED5D32714440B8206066C57852C09B8129A12E7144407FCA2B50C57852C0DC48F83A28714440CDD7CA08C67852C04966D14220714440504E443FC67852C0B4D114101E7144407243945CC67852C0D412AC3A1C714440BC9FB29FC67852C0606E78BA0C714440561B92C5C67852C0780315170B714440CC171D04C77852C02F7233020A7144408FFBE192C77852C09AC205E50871444018627A68C87852C01E760EF2077144404CBC7516C87852C0FDA73C40007144402EF437D8C77852C0CB722308FE7044404ED3ED4FC77852C05C406144F8704440A235B0BFC57852C0380AC000F57044401B2CA36AB37852C0B77F8577B4704440F794E762B17852C0634A6ED2A0704440CEC56EB6B07852C0ACE22549977044401DB47137B07852C0E9300F558D70444034CFF2E6AE7852C0F5A2F9E47E7044405CD3B7A9D07852C0F3E26FA5427044407BCFD84ED67852C05ADE91B429704440054295FAD87852C0CC2E473C1D70444009A22B1EDE7852C09D5C2F7706704440244C0477EB7852C00F32BBFDCA6F4440692A3858DF7852C07023B9C3B66F44404E56247EDE7852C0E67FBA57B56F4440FF0C8CCAD47852C0634A8226A56F4440B7800A91D27852C0786CF46FA16F4440638D7AEDD37852C0DD8CC8AF9E6F44409138047DDA7852C0D3DE0E30946F4440B30AF334E07852C0AB84E0268D6F4440FF74D1CDE27852C0CB7ECCF8896F44408B3F7893ED7852C0785C029A7D6F4440D7574C68F47852C0DFA260BD756F4440996A35C4FC7852C0CFF5AA1E6C6F4440534236EE057952C00A85236D616F44408AC07A50097952C0A01B207D5C6F444048C96B860C7952C065350247576F4440862A668C0F7952C020E647D0516F444094C9385F127952C022B6231F4C6F4440BB82CE2B157952C0198FA24A456F44402B76D3021A7952C0E4C3829F386F4440C88B12A81D7952C05A24B3F52E6F44405A61CBF4267952C09AC612BA166F4440FFC9DE1F327952C0F97B403AF96E4440F583F962337952C0DB570CC3F56E4440B9AF68D6367952C0D40A06D3EC6E444055878EB8387952C0088132F2E76E4440BB6DA0823C7952C0239DC221DE6E444038FB20443D7952C0DC968717DC6E444090E6138B3D7952C0EE041858DB6E4440CA67CDFC3F7952C0CF76E4CCDD6E44407191639A4D7952C0AEAF4F7BEB6E4440EF979FEE4E7952C08C3937D1EC6E4440D275DC315D7952C0DDF3BA1EFB6E44404E40F80D6F7952C08277ED64096F4440C462BC3F617952C03167FC242D6F444039F8A3E1877952C09C0DE0F8506F4440A78F9F6A8A7952C012AD5A9B4C6F444072665CB88C7952C0FFFEA7E3476F4440CCF81DC38E7952C004BD30DD426F444085B95784907952C02B6210953D6F44405BDD3CF7917952C09194401A386F4440DCF77918937952C06BC9657C326F4440136DD4E6937952C0E753E3CB2C6F444063DE322B907952C0796823B8166F44408EE7F809997952C0B32CE1301B6F4440BC183E0EAB7952C0F37E4EED236F4440A87232B8AE7952C0025805A8256F44406DA03A56B27952C0E16F3D99276F4440230AF7E6B57952C03BFF39C0296F444011410D69B97952C0D7002A1C2C6F4440312B28DBBC7952C0B0F727AC2E6F4440F6DBF83BC07952C01ED43A6F316F4440CDBF7ACFCD7952C0DBE62E46406F4440799A3A09D77952C0E0A7D5E84E6F44402FE57FB9DB7952C08DFB837E5A6F444053378E04E27952C0501090FF676F4440CC1E2D24E37952C0944E2D1E6F6F4440BA115A40E27952C00EBBFABBA56F44404AF39D58E27952C034932B85A86F4440C421AA58E27952C0F94CEF85A86F4440AFE3C258E27952C0C6A99B86A86F44405D6CCED1E27952C01E05C34EAB6F4440FBB300D2E27952C0EFEAD04FAB6F4440BB424ED2E27952C04072B950AB6F4440398744AAE37952C0E76DBAEAAD6F44408219CFAAE37952C044054FECAD6F444062C38EABE37952C0AF26D3EDAD6F4440CE4D61D5E47952C0BD441831B06F4440FDACA1D5E47952C004DB8B31B06F4440D0EDFAD5E47952C0D47BFF31B06F4440DBB48B3BE67952C0CA241A02B26F4440CFB5EA38F77952C0E4271DFFC26F44403E4B17B6F97952C086100E73C46F4440AA0B3D73FA7952C0106D6BE1C46F4440ED6E5033FC7952C02942E8E6C56F4440632F8733FD7952C0292E5B68C66F444028BC0FC9FC7952C065398912C86F4440BB927ED9F47952C0A84918CDE66F4440563BBDAAEE7952C0E13F70A8FD6F44409D903864EE7952C0120125ADFE6F4440241FAD3DEB7952C02A8331EF0A704440E040924DE87952C0FD16CF5017704440C1BF9E94E57952C0A6F7CECE237044405AD39413E37952C025E8C96530704440A2524E15DE7952C04B5319914C704440D0F36978D97952C0BC81C045667044406578A721D67952C0820DB5BD7270444076B80642D07952C04A2BF04182704440A2F580ABBE7952C0B0FED861A77044403F59AB48B27952C010F35F21C3704440AF0A2DBF977952C01E8CCF8800714440FC21BE958B7952C0E99696AC1C7144400CDF5EDA817952C01622E93033714440649B87F27F7952C0ACBA0F7736714440D05275A57E7952C012235BB338714440719390247A7952C07EAE3370407144401B07B7CC757952C0B85439A74771444006014D49727952C095D8537D4D71444018096D496A7952C0501CDA565A714440856AD525627952C0231058FB6671444021A35198607952C010751D6266714440C1D2F95A577952C0D0D791D2627144403203FA08497952C0F5DD76B35C714440F4FBC26D427952C0CE88AAB758714440AC55D90C407952C07CEF72255B714440DCC0FB8A257952C0D51A94E251714440AC4C300D257952C052F33D575071444041C573B2127952C03983385049714440EFC4D1F4027952C0B37C785943714440987AE840F37852C09F58ED613D714440C94DD1ADE37852C018E8A56C37714440D4704492DB7852C0D0F02694347144408EAFDFDBD07852C0B20F305630714440F0FB0936CE7852C098CCC2492F714440FA725773C57852C0BA3EED5D32714440</td>
        </tr>
        <tr>
            <td>7</td>
            <td>2.0</td>
            <td>Bronx</td>
            <td>005</td>
            <td>BX41</td>
            <td>Mount Hope</td>
            <td>14716710.6424</td>
            <td>18937.2474976</td>
            <td>010600002032BF0D000100000001030000000100000055000000D1B8B5A7517952C020C5D68F626D44408D5D974B627952C04D33CD24286D44406197DCDF697952C0F929E74B0D6D4440AFB6A53D7A7952C0A3339CC8D36C4440582B462A877952C0D2B748D8A56C444050E9D433947952C0174963D9786C4440C2DD4DE39C7952C0BED6E13E596C4440A62EA026A87952C0DE6A07D3306C44401DCBB636AB7952C02913ABD8256C444000101559AE7952C0FA0B609D1A6C4440C27DC02EAF7952C0BF87DBB8176C4440F303EF9EAF7952C0902DC63D166C444033894FA4C57952C0FA22E53E1B6C44401FAAA915D17952C032152CAA1D6C44408E1FBFCADC7952C09F88BB23206C44401B4134C1E87952C02E78E86A226C4440479BCFD0E87952C04ED592DA206C44400DB839EFE87952C029F755FF1D6C444068841601E97952C06DF10E811B6C4440F37EDC98E97952C01ECEE3A90B6C4440BF1462C9E97952C0C12E5399066C4440C4DC3711EA7952C03DD70A1AFF6B44402D8B617EEA7952C0360264B5F36B44400EBFA8C4EB7952C079A3CAEAD36B44409BD9D0F5ED7952C0986F2496D86B4440BC5780BAF97952C01EBE38A9D96B444011FC3D42FB7952C0786EE341DB6B4440094790C1097A52C0D3A26D87DC6B4440C00ADE7A187A52C0EF640BAADD6B4440795D6CAA1A7A52C0DB5B26BFDD6B4440C8D95870277A52C03B95733ADE6B4440C04589AD367A52C09A99DE70DF6B4440B0865EFA447A52C070F5B798E06B444038724C7D447A52C0D4AF3DF4EA6B44408A57C74F4D7A52C0236A31E3EB6B44404BC5D92A5A7A52C08EC53B4EED6B444042F2D4DD5C7A52C0FAB3DADFEF6B444085A4F00B607A52C0B28B73F4EF6B44400A0AA4936D7A52C0BB1A3301FB6B4440AE4738106F7A52C0E390DA72FC6B4440088E3DA67C7A52C037BD437F076C4440796D3B2B8B7A52C0606C486A136C4440C0156F8E9D7A52C044081435226C444066E1B8B2A17A52C0EF89103C246C444021D2A78EAD7A52C071D07E472B6C4440F32355A9AF7A52C02DA782BC2C6C44400C895DFF987A52C0680A2DC82D6C4440FD52C9A98B7A52C04CC686612E6C44407C74259C817A52C003EDE0C82E6C4440C12CF90E817A52C0A6AA0876306C4440233776927E7A52C023181608376C444006BA5CE87A7A52C07820EB0F416C44407113858E787A52C059591ECF476C444087E4AD34767A52C09F2C518E4E6C444089B8D50F717A52C08E35A1A25C6C4440E49156866F7A52C0036188F4606C4440317AB229647A52C0AA5E3DE3806C4440A7357CC25D7A52C083F191C9926C44404786B2F6587A52C097DD4338A06C4440B41401D44F7A52C0D3A374BBB96C44402A4728D2487A52C0779A026DCD6C444080B376F8467A52C00CC821C0D26C4440F68A0596307A52C077E138D0076D4440EA229D82237A52C04530CA6E236D44402954FFBD117A52C099AB34DB496D4440F34F2DDCF47952C0840161708A6D44402146CF08E77952C0EAE1EFC67C6D44409821038CDA7952C0EA1026556F6D444078C0E390CA7952C0A2A38A34696D44403DDFCCADBB7952C0F3FCF845646D44406503D712B87952C0D1573514636D4440693663C8B27952C00196E776706D4440E0EC80EBAE7952C043DAB2957A6D4440C67FC7B3AC7952C01C0EDCE1806D44402459C59AA77952C0FCD0A85B8F6D44401E05EA5DA67952C0410FA2F3926D444013285F7EA37952C0003664FD906D4440C6440238947952C0F3E10C8F866D4440C0FAB58B857952C0153DFA8A7C6D4440D2034D8C7B7952C00FF3BB6F756D444097B5353E837952C08BA9E2D24C6D444033A933EE7D7952C06C4634E0516D444044C10C136A7952C0CB051F49766D4440042215485F7952C0C855119E6D6D4440D1B8B5A7517952C020C5D68F626D4440</td>
        </tr>
        <tr>
            <td>3</td>
            <td>4.0</td>
            <td>Queens</td>
            <td>081</td>
            <td>QN55</td>
            <td>South Ozone Park</td>
            <td>82461393.7722</td>
            <td>36708.169488</td>
            <td>010600002032BF0D00010000000103000000010000009A000000A797A1B5917352C04EE61E546A5744408CB4D69B8D7352C01419F9265957444073EC1AD6887352C0BB1A6A2945574440D16A1FF8837352C0FB6B9DCE3057444032D5744E7F7352C07963E83D1D5744400069E85E797352C0EC1F504104574440C5A95969767352C0106D3662F75644404638F61F687352C0AE7ABC40BE564440335F8B95657352C0B3B5BA42B35644401AC544125F7352C0EED4417C975644401691A9575A7352C08EEA80838356444040409461547352C06243FE246A564440BBAECCC14E7352C09509BF35525644406E1D42344D7352C0CEFD9B6D49564440E88B36D54C7352C02B77023447564440AD990F2C4A7352C0BA49DF41375644405F3CC686487352C09B1B96D82856444004D1C7C5467352C0314977F011564440BE625C68467352C01AC581D00A564440F8C1DD31467352C0F45C759E00564440FA703D21467352C0C3C07A83FD554440E393B2EA457352C0C18E2051F3554440C48A01D4457352C0EBCD8713EF5544402E42CDC8457352C0526918FAEC554440DDCAABC0457352C0F6E5EA89D4554440E9B8A134467352C0E8762B05BC554440C89BAA84467352C0317DD713A55544407F2188DA467352C033FE93C99F5544407CF27E1D477352C0683E4EA49C55444089E8056B477352C0F26A9F1196554440B4EBBFDE477352C0BA494BCF8D55444066C59833497352C0D75B9E9C79554440C4A2D1724A7352C07993EADC6B554440DABDA5054B7352C0FDFF300366554440C803B1464C7352C02EE387EB5A554440EC4415B04C7352C07D659B2C58554440474952864E7352C04ECD90B54B5544402C8FCFC44E7352C06671040D4A554440E661031A4F7352C0E3341C244855444091DBE249517352C09D6479973B5544408928597E547352C0B62FE7D82655444041B55A67567352C03BD113E9265544405D644746647352C02BF360D1255544407622B90D717352C03AF309F8235544408CE1B6FC797352C0FFD91AAD2255444001984DFB907352C06D47266E1D554440BAB9D5DC977352C01D793FDC1B554440D7C2AF81B07352C022CC703612554440BF5B71F5B27352C06BD9AB4011554440E359BFA5BD7352C0AB1D62110D554440E81DC521C47352C0255ABDB4075544404C4A402ECE7352C072628E65FF544440DEB00029D87352C088FBFD24F7544440590AA60AE17352C01EC2CCF0EC54444076F82925EA7352C00F47DCFFE2544440D4ED5CFDF37352C0C769F209DB54444058C67881FC7352C08A1CF660D754444055A5152E057452C0FEB88127D4544440411CA1ED0D7452C0D088DD63D154444095B5F9BB167452C0DBE16117CF544440C03D11951F7452C00D221943CD544440E400AE74287452C0DF4786E7CB544440A4050CC3587452C0382A23BEDB5444404E2FBDE2AC7452C0CBC85D55EF544440C41A32D7C07452C038D9AB13F05444409E102784CA7452C0D42C9115F0544440F1D23C5ECD7452C0B58E9F31F05444402DC15178D87452C0912AB99EF05444406D425D02E27452C0ABB6D619F2544440F83EFE7EEB7452C009F39541F454444007C1D1BFEF7452C0171F97EFF55444401C022A46FC7452C02C24C2E1FA544440BEB2D9FA0F7552C0CF360E2B06554440324818B4147552C0297B9CE609554440E788BA3C1F7552C05077EF0411554440777593A7437552C034E14A95285544407BD3D08B487552C04AEB12DB2A554440C198550B4B7552C0E6F82F042C55444063D1A67C4D7552C0B6374F5637554440B4A2B9F54D7552C024FEA7433955444056814ECF4E7552C03E46F34C3C554440BFBDA793557552C0D709E4D25855444030692D3F757552C09DC4B038DD55444061FD896B787552C0798361F1E95544409E63B725817552C01276CDED0C564440EB8996CF877552C0D616D1A62856444018C81D478E7552C0B2A79F5B44564440C7C399A9937552C06FB9576D5B564440C9EFA287997552C041CA15BB73564440D22B463B9F7552C0DD7B5DBA89564440B921D5BFA37552C08880E6CE9B564440C4C39ED9A07552C0826E5131A15644400682D5B4BA7552C0FF6493FD0857444045C695AAC47552C0C1043ED02F57444019E5E0D6BA7552C0C0C3BAA3335744400C10CF73AC7552C01A673F5E39574440C8A3E9789E7552C09C8056FB40574440740DEE549E7552C068141C1741574440B7E7EA359D7552C0FD91A5F441574440793FE9AB937552C00DAF825149574440FB3A444B937552C0059A199C49574440D12703FF907552C02D4724624B57444040429C10A37552C0A3E9FD23955744403580CF4C947552C00A59868B9D5744400E90E637807552C0A95F0EF4A8574440E917658D727552C08637F3DCB05744405218C483647552C0F9B3CDDBB857444086A7D6C8567552C01AF260AFC0574440362D0AF3487552C00F7C9880C8574440A9F608F33A7552C09E8A6F82D0574440B234A33A2D7552C08B66D23CD85744408562545D1F7552C0C482AC31E057444035EC2653117552C0FD37121BE8574440E98EC2C9037552C0368144B5EF57444006994841F67452C0446F9F76F7574440F40A8B54067552C061F542FC38584440558C0DC7F87452C0BDDAD1B5405844404542DF2FEB7452C09D7DEE66485844401143BB13DD7452C0AC93CF665058444066FA25FCCC7452C0696D52D20E584440A7D70C18BC7452C04765C36B18584440CB62A9EBAA7452C0B0D1532D2258444007470EE7997452C0BD76DAD92B584440B28584D9887452C0B8A5338E3558444032445EE2797452C0E29E720D3E584440F6CBC97D6B7452C0B01A1B34465844402596772D5D7452C054882D624E584440A086B985487452C04780E81D5A584440F0B91C923A7452C05DF9FC0C62584440ED0E2EB32C7452C0BC425FF469584440E368A9DF1E7452C00BDCDAC471584440F232AC0A117452C028BD359D795844400A72D7CE097452C0EF878F1C7D58444068DCC590037452C067CF080D80584440D127DC90F57352C0409E9F5587584440AA34A73AE77352C0DD59C3B48E5844402403C8EEE27352C0C594F7E990584440BFE02969E17352C0285C59BB915844404A89BF0ADB7352C0DE2441537B5844408B3ABE51D67352C051B040B26A584440F0148A81D27352C01E82DD445D584440443EE4A1CF7352C0FACE7A26535844406FFEBDACC97352C00A825F463E584440F6B07C06C97352C09C7ACBFF3B5844404B57E369C57352C0E723F0572F5844407EE27474C27352C0EFAC99E4245844400BC4DCB7BF7352C08640023A1B5844406BBE9779B77352C002C94174FE574440CB8F1238B47352C084FB9CD6F2574440CC088865AB7352C0EAE369F5D2574440D777795FA77352C0D8FBE8BBC25744405B34246F9F7352C0C8AABCA1A3574440C8752F85967352C09BAF94B57E574440A797A1B5917352C04EE61E546A574440</td>
        </tr>
        <tr>
            <td>4</td>
            <td>3.0</td>
            <td>Brooklyn</td>
            <td>047</td>
            <td>BK40</td>
            <td>Windsor Terrace</td>
            <td>14041667.9508</td>
            <td>19033.6718103</td>
            <td>010600002032BF0D000100000001030000000100000086000000C877B521BB7E52C0A7F542B7A0544440E31925B3BB7E52C0E0F5B31E9F5444406DA1D5B3BB7E52C0A029AC1C9F54444078C13BB4BB7E52C0A7088E1A9F5444408712760ABC7E52C01ED99C399D544440C0B7B40ABC7E52C0F71F55389D54444015C2B40ABC7E52C0A4C844379D544440C03D7812BC7E52C02949E92C9B5444400E428612BC7E52C0B934CC2A9B5444409B4A2D12BC7E52C015CC86289B54444076263DC3BB7E52C04FDAA224995444407366F1C2BB7E52C06B84AB2299544440161866C2BB7E52C0FD03162199544440E0CBC023BB7E52C0533896519754444051136723BB7E52C05DED865097544440BE3DC222BB7E52C0E7FA654F97544440ED16C549BA7E52C0986B26DA9554444014ADE148BA7E52C09CF791D8955444405B58BC47BA7E52C091AB5AD795544440F878A44EB97E52C0761DA4CA945444404FDFBB57B87E52C0BC7E52B5935444407469B256B87E52C0E66E30B4935444409083A755B87E52C0710096B3935444405A37FF1EB77E52C05D4BAAF492544440B56F7F1EB77E52C0C29E5DF4925444400615E71DB77E52C0F94247F49254444082CAD0BDB57E52C0579D7FB792544440F80361BCB57E52C0B60047B792544440B11D22BBB57E52C04D8593B79254444065B40D57B47E52C037DEFC1393544440FF7A0356B47E52C0BB7B4A14935444400502EC54B47E52C043A51E15935444400E68D215B37E52C08A8BEFFF93544440EB472015B37E52C0DAC07600945444409E789314B37E52C062302501945444403E0B2919B27E52C06F9DBE5195544440EF934418B27E52C0C9BAF55295544440A6D48617B27E52C02EE4B05495544440D21DDD6AB17E52C0E040CBD696544440F3D54A8D8F7E52C067680062765444404CF680FA687E52C044ED4C07515444407D942DEB5D7E52C0AE3B937744544440A0FE74075C7E52C0D32E51803F544440BAC676655A7E52C0207C8D493A54444014BF420A597E52C03520ACDF345444404044290A597E52C02E5610DF34544440F92575F9577E52C078B7124F2F544440EB179735577E52C0A3338BA72954444071EB7C35577E52C0004DA5A62954444087746335577E52C08C29BCA529544440815B17BF567E52C0DCE46BF4235444408C8A429B527E52C00F59E6A904544440079A60B94E7E52C02013FE23EC5344405E72A7FE497E52C003F7088CCB534440EF3CDA77467E52C0D583AF67B3534440E202B86F407E52C0448511AF89534440EEA614473C7E52C06B50708D6C534440FE293A4B3B7E52C049913BA965534440BF4229A13A7E52C0EE0BE10161534440692344753B7E52C0CCDEF5AC6053444059BC8F413C7E52C06CAE7B3360534440366157033D7E52C0FB5A0E975F534440F6A709B83D7E52C00EDBBFD95E5344401D48425D3E7E52C0948812FE5D534440FE12D1F03E7E52C0CB35EF065D5344409D94708E3F7E52C0D9B8408D5B5344401D53640B407E52C0B03034F8595344403E72A965407E52C0B4C44F4E58534440E39FCB9B407E52C01E1A6F965653444051B7F2AC407E52C0297D875A55534440C1A36CA6407E52C0F69EB31D54534440160A4F88407E52C0E4260EE452534440E578FE52407E52C006F0A5B15153444006F72A07407E52C0E633748A505344409FFACFA53F7E52C0ACDC4B724F53444099ED5B453F7E52C08C55AA7E4E534440E90138DB3E7E52C0790891944D5344406FFECD673E7E52C07849E4B44C534440514C8CEB3D7E52C0CD6E7EE04B534440CDA8CD3C3D7E52C08E94E7EA4A53444072C5767D3C7E52C0CFF8EB134A5344403838D4AF3B7E52C0B6651F5E4953444063285ED63A7E52C01156B2CB485344400214E0CE397E52C03FF4C29048534440879DF9C4387E52C0FF9E0D7A48534440B800CFBA377E52C0277BC08748534440724885B2367E52C0CF01C0B948534440D683DAD5357E52C019A6F01C435344405A6566C1337E52C0001675E2345344400F6713072E7E52C0CB345FA00C534440811D755B2B7E52C0645E731CFA5244401100A04F287E52C0A6DE9B37E55244404693DD42227E52C0A6CB7388BC5244405056AB0D317E52C0B0B3142AB052444035D023A7367E52C049D2DC9DAB52444080F2E54A477E52C0AFFC37239E524440028A2A4F587E52C01A55C255905244406F1C32F55C7E52C0331AE6828C52444028EDDC89607E52C0BD8E533D89524440B48CEA01617E52C0296A993B8D52444090359845627E52C0FB6752FF97524440FDB38892637E52C0FB6C5619A55244400FF8C075757E52C0FE98DA31A1524440E2C1D5AB847E52C015461AD89D5244405D5E56D9937E52C0D0E9E68C9A524440E53E59AD9A7E52C0DA6CB621E25244405E2276DFA97E52C0D0CD36ECDE52444072931C17BD7E52C00B9225A2DA524440E3EBE745BE7E52C0B35EECA0E7524440905A33FBC37E52C02FFCF39A23534440F271E77DCA7E52C0F9B69D5B67534440B585D291CD7E52C01BB435A0895344402A85FB1FD07E52C0EAB28125A3534440D6F393BDD57E52C02910A71ADF534440D19FAE3FFA7E52C05E3DF12D0B5444405C306C5A1E7F52C01B6B06BD36544440F15A9375427F52C09DF5FC57625444400AD7C0C7387F52C03F1F05E174544440EDB3C060327F52C0AF8B8717815444400466AD17307F52C0BE9B5DAE8554444063AA831D2F7F52C08E30324C8754444002D5CE2A2D7F52C05968B625875444404CEE361E297F52C0FC46C6E286544440749D9FD6277F52C052E880CE825444405A51444C267F52C0CFE8C8EA7E54444049A14084247F52C064FC1F467B54444035986E85227F52C043A24BED77544440ACF279A90B7F52C008B6248C5A544440E3006AB9017F52C0F5EAE1B76D54444086D7E482F87E52C070C19D627F5444405815635BED7E52C04FEDE08E9954444078EBF316E57E52C030E16753AD5444400926A7DCDC7E52C0D46F6C0DC1544440C877B521BB7E52C0A7F542B7A0544440</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT UpdateGeometrySRID(&#39;nyc_nta_2010&#39;, &#39;geom&#39;, 4326);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
1 rows affected.
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>updategeometrysrid</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>public.nyc_nta_2010.geom SRID changed to 4326</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

ALTER TABLE nyc_nta_2010
ADD COLUMN IF NOT EXISTS geog geography;

UPDATE nyc_nta_2010
SET geog = geom::geography;

ALTER TABLE nyc_nta_2010
ADD COLUMN IF NOT EXISTS geom_2263 geometry;

UPDATE nyc_nta_2010
SET geom_2263 = ST_Transform(geom, 2263);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>195 rows affected.
Done.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>195 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>
-- add spaital indexes
CREATE INDEX IF NOT EXISTS nyc_ntas_2010_geom_idx on nyc_nta_2010 USING gist(geom);
CREATE INDEX IF NOT EXISTS nyc_ntas_2010_geom_2263_idx on nyc_nta_2010 USING gist(geom_2263);
CREATE INDEX IF NOT EXISTS nyc_nta_2010_geog_idx on nyc_nta_2010 USING gist(geog);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
Done.
Done.
Done.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>This bit is just for re-running the code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> DELETE FROM sites WHERE id &gt; 7
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql+psycopg2://docker:***@0.0.0.0:25432/storms
2 rows affected.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="dv-lab-08.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Geometry Operations and Spatial Analysis</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="dv-finalproject-2.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NYC Storms &amp; 311 Flooding Service Requests Part 2: Storm Identification &amp; Spatial Queries</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Daniel Vignoles<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>